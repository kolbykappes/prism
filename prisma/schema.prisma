generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum FileType {
  txt
  vtt
  srt
  pdf
  md
}

enum ProcessingStatus {
  queued
  processing
  complete
  failed
}

enum ActivityAction {
  uploaded
  reprocessed
  deleted
  summary_completed
  project_created
}

model Project {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  description String?
  overview    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Future-proofing
  userId       String? @map("user_id")
  googleDocId  String? @map("google_doc_id")
  googleDocUrl String? @map("google_doc_url")

  sourceFiles       SourceFile[]
  markdownSummaries MarkdownSummary[]
  activityLogs      ActivityLog[]

  @@map("projects")
}

model SourceFile {
  id         String   @id @default(uuid()) @db.Uuid
  projectId  String   @map("project_id") @db.Uuid
  filename   String
  fileType   FileType @map("file_type")
  fileSize   Int      @map("file_size")
  blobUrl    String   @map("blob_url")
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  uploadedBy String   @default("Kolby") @map("uploaded_by")

  project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  markdownSummary MarkdownSummary?
  processingJobs  ProcessingJob[]

  @@map("source_files")
}

model MarkdownSummary {
  id               String           @id @default(uuid()) @db.Uuid
  sourceFileId     String           @unique @map("source_file_id") @db.Uuid
  projectId        String           @map("project_id") @db.Uuid
  blobUrl          String?          @map("blob_url")
  content          String?
  generatedAt      DateTime?        @map("generated_at")
  llmModel         String?          @map("llm_model")
  processingStatus ProcessingStatus @default(queued) @map("processing_status")
  errorMessage     String?          @map("error_message")
  tokenCount       Int?             @map("token_count")
  truncated        Boolean          @default(false)
  promptTemplateId String?          @map("prompt_template_id")

  // Future-proofing
  verbosityLevel String? @map("verbosity_level")
  summaryStyle   String? @map("summary_style")

  sourceFile SourceFile @relation(fields: [sourceFileId], references: [id], onDelete: Cascade)
  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("markdown_summaries")
}

model ProcessingJob {
  id           String           @id @default(uuid()) @db.Uuid
  sourceFileId String           @map("source_file_id") @db.Uuid
  status       ProcessingStatus @default(queued)
  createdAt    DateTime         @default(now()) @map("created_at")
  startedAt    DateTime?        @map("started_at")
  completedAt  DateTime?        @map("completed_at")
  errorMessage String?          @map("error_message")

  sourceFile SourceFile @relation(fields: [sourceFileId], references: [id], onDelete: Cascade)

  @@map("processing_jobs")
}

model ActivityLog {
  id           String         @id @default(uuid()) @db.Uuid
  projectId    String         @map("project_id") @db.Uuid
  action       ActivityAction
  sourceFileId String?        @map("source_file_id") @db.Uuid
  userName     String         @default("Kolby") @map("user_name")
  metadata     Json?
  createdAt    DateTime       @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

model PromptTemplate {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  content   String
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("prompt_templates")
}
