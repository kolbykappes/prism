generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum FileType {
  txt
  vtt
  srt
  pdf
  md
  email
  ics
}

enum ProcessingStatus {
  queued
  processing
  complete
  failed
}

enum ActivityAction {
  uploaded
  reprocessed
  deleted
  summary_completed
  project_created
  person_added
  person_removed
  email_ingested
  otter_ingested
}

model Project {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  description String?
  overview    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Future-proofing
  userId       String? @map("user_id")
  googleDocId  String? @map("google_doc_id")
  googleDocUrl String? @map("google_doc_url")
  emailAlias   String? @unique @map("email_alias")

  sourceFiles       SourceFile[]
  markdownSummaries MarkdownSummary[]
  activityLogs      ActivityLog[]
  projectPeople     ProjectPerson[]

  @@map("projects")
}

model SourceFile {
  id         String   @id @default(uuid()) @db.Uuid
  projectId  String   @map("project_id") @db.Uuid
  filename   String
  fileType   FileType @map("file_type")
  fileSize   Int      @map("file_size")
  blobUrl    String   @map("blob_url")
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  uploadedBy    String   @default("Kolby") @map("uploaded_by")
  ingestSource  String?  @default("manual_upload") @map("ingest_source")

  project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  markdownSummary MarkdownSummary?
  processingJobs  ProcessingJob[]

  @@map("source_files")
}

model MarkdownSummary {
  id               String           @id @default(uuid()) @db.Uuid
  sourceFileId     String           @unique @map("source_file_id") @db.Uuid
  projectId        String           @map("project_id") @db.Uuid
  blobUrl          String?          @map("blob_url")
  content          String?
  generatedAt      DateTime?        @map("generated_at")
  llmModel         String?          @map("llm_model")
  processingStatus ProcessingStatus @default(queued) @map("processing_status")
  errorMessage     String?          @map("error_message")
  tokenCount       Int?             @map("token_count")
  truncated        Boolean          @default(false)
  promptTemplateId String?          @map("prompt_template_id")

  // Future-proofing
  verbosityLevel String? @map("verbosity_level")
  summaryStyle   String? @map("summary_style")

  sourceFile SourceFile @relation(fields: [sourceFileId], references: [id], onDelete: Cascade)
  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("markdown_summaries")
}

model ProcessingJob {
  id           String           @id @default(uuid()) @db.Uuid
  sourceFileId String           @map("source_file_id") @db.Uuid
  status       ProcessingStatus @default(queued)
  createdAt    DateTime         @default(now()) @map("created_at")
  startedAt    DateTime?        @map("started_at")
  completedAt  DateTime?        @map("completed_at")
  errorMessage String?          @map("error_message")

  sourceFile SourceFile @relation(fields: [sourceFileId], references: [id], onDelete: Cascade)

  @@map("processing_jobs")
}

model ActivityLog {
  id           String         @id @default(uuid()) @db.Uuid
  projectId    String         @map("project_id") @db.Uuid
  action       ActivityAction
  sourceFileId String?        @map("source_file_id") @db.Uuid
  userName     String         @default("Kolby") @map("user_name")
  metadata     Json?
  createdAt    DateTime       @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

model PromptTemplate {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  content   String
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("prompt_templates")
}

model Person {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  email        String?
  organization String?
  role         String?
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  projectPeople ProjectPerson[]

  @@map("persons")
}

model LlmUsageLog {
  id           String   @id @default(uuid()) @db.Uuid
  sourceFileId String?  @map("source_file_id") @db.Uuid
  projectId    String?  @map("project_id") @db.Uuid
  model        String
  inputTokens  Int      @map("input_tokens")
  outputTokens Int      @map("output_tokens")
  totalTokens  Int      @map("total_tokens")
  durationMs   Int?     @map("duration_ms")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("llm_usage_logs")
}

model ProjectPerson {
  id            String   @id @default(uuid()) @db.Uuid
  projectId     String   @map("project_id") @db.Uuid
  personId      String   @map("person_id") @db.Uuid
  role          String?
  notes         String?
  autoExtracted Boolean  @default(false) @map("auto_extracted")
  addedAt       DateTime @default(now()) @map("added_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  person  Person  @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([projectId, personId])
  @@map("project_persons")
}
